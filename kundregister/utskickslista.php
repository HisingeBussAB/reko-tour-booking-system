<?phpinclude ("../config-connect.php");mb_internal_encoding('UTF-8');?><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"><HTML> <HEAD> <TITLE>Utskickslista</TITLE> <meta http-equiv="content-type" content="text/html" charset="UTF-8" /> <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW"> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <style> @media print {    .page-break	{ display: block; page-break-before: always; }        .no-print, .no-print *    {        display: none !important;    }  }  @page {    size:8.27in 11.69in;     margin:0;     mso-header-margin:0mm;      mso-footer-margin:0mm;     mso-paper-source:1;  }  body    {     margin: 0px;    }  </style> </HEAD> <BODY style="font-family: Arial, Helvetica, sans-serif" ><?php	      $kategorier = array();      $kategorier = $_POST["kategori"];            $pastdate = "-" . $_POST["years"] . " year";         $datelimit = date('Y-m-d', strtotime($pastdate, time()));            $sql = "SELECT (SUBSTRING(efternamn, 1, 3 )), fornamn, efternamn, telefon, email, adress, postnr, postort, kategori, Resor.date AS datum, 'R' as src, Resenarer.resenarid AS id FROM Resenarer INNER JOIN Resor ON Resenarer.resaid = Resor.resaid WHERE Resor.date > CONVERT(date, '" . $datelimit . "', 126) AND Resenarer.resenarid NOT IN (SELECT resenarid FROM Hidden) AND adress != ''";                    if (!in_array('0ALLA0', $kategorier)) {            foreach ($kategorier as $kategori) {      if ($kategori === reset($kategorier)) {        $sql = $sql . " AND (kategori='" . $kategori . "'";      } else {        $sql = $sql . " OR kategori='" . $kategori . "'";      }      if ($kategori === end($kategorier))        $sql = $sql . ")";      }            }            if ($_POST["program"] == "JA") {        $sql = $sql . " UNION ALL SELECT (SUBSTRING(efternamn, 1, 3 )), fornamn, efternamn, telefon, email, adress, postnr, postort, kategori, datum, 'P' as src, Programbestallningar.id AS id FROM Programbestallningar WHERE datum > CONVERT(date, '" . $datelimit . "', 126) AND Programbestallningar.id NOT IN (SELECT programbid FROM Hidden) AND adress != ''";            if (!in_array('0ALLA0', $kategorier)) {            foreach ($kategorier as $kategori) {      if ($kategori === reset($kategorier)) {        $sql = $sql . " AND (kategori='" . $kategori . "'";      } else {        $sql = $sql . " OR kategori='" . $kategori . "'";      }      if ($kategori === end($kategorier))        $sql = $sql . ")";      }            }            }      $sql = $sql . " ORDER BY (SUBSTRING(efternamn, 1, 3 )), datum DESC, efternamn, fornamn;";            // echo $sql . "<br>";      $email = array();      $telefon = array();      $namecheck = array();      $i=0;            echo "<table class='page-break'>";      $double = false;              $left = 0;      $top = 0;            if ($result = sqlsrv_query($conn, $sql, array(), array( "Scrollable" => SQLSRV_CURSOR_KEYSET ))) {                      if (sqlsrv_num_rows($result) > 0) {                while ($row = sqlsrv_fetch_array($result, SQLSRV_FETCH_ASSOC )) {                                $namechecktemp = $row["efternamn"] . $row["adress"] . $row["postnr"];                $namechecktemp = preg_replace('/\s+/', '', $namechecktemp);                $namechecktemp = mb_strtolower($namechecktemp);                $namechecktemp = preg_replace('/gatan/', 'g', $namechecktemp);                $namechecktemp = preg_replace('/vägen/', 'v', $namechecktemp);                $namechecktemp = preg_replace('/väg/', 'v', $namechecktemp);                $namechecktemp = preg_replace('/[.,]/', '', $namechecktemp);                $namechecktemp = preg_replace('/västra/', 'v', $namechecktemp);                $namechecktemp = preg_replace('/östra/', 'ö', $namechecktemp);                $namechecktemp = preg_replace('/norra/', 'n', $namechecktemp);                $namechecktemp = preg_replace('/södra/', 's', $namechecktemp);                                   if ((($row["email"]!="") AND (in_array(mb_strtolower($row["email"]), $email))) OR (($row["telefon"]!=0) AND (in_array($row["telefon"], $telefon))) OR (in_array(($namechecktemp), $namecheck))) {                  $double = true;                }                                                if (intval($_POST["levenstein"]) > 0 AND $double == false) {                                foreach ($namecheck as $namechecka) {                                if ($double == false)                  $lev = levenshtein($namechecka, $namechecktemp);                                                if ($lev <= intval($_POST["levenstein"]))                  $double = true;                                  }                }                                                $email[$i] = mb_strtolower($row["email"]);                $telefon[$i] = $row["telefon"];                $namecheck[$i] = $namechecktemp;                                $i++;                                if ($_POST["format"] == "staples24") {                                if (!$double) {                                if ($left == 0)                  echo "<tr>";                                echo "<td style='width:70mm;height:36mm;padding-left:10mm' valign='center'>";                echo $row["fornamn"] . " " . $row["efternamn"] . "<br>";                echo $row["adress"] . "<br>";                echo chunk_split($row["postnr"], 3, ' ') . " " . $row["postort"];                echo "</td>";                                $left++;                                if ($left > 2) {                $left = 0;                $top++;                echo "</tr>";                }                                if ($top > 7) {                echo "</table><table class='page-break'>";                $top = 0;                $left = 0;                }                                }                                } else {                                if (!$double) {                                echo "<tr>";                echo "<td width='1%'><a href='hide.php?src=" . $row["src"] . "&id=" . $row["id"] . "'><input type='button' value='Dölj permanent'></a></td>";                         echo "<td>" . $row["fornamn"] . " " . $row["efternamn"] . "</td><td>" . $row["adress"] . "</td><td>" . chunk_split($row["postnr"], 3, ' ') . "</td><td>" . $row["postort"] . "</td><td>" . $row["email"] . "</td>";                if ($row["telefon"] != 0)                  echo "<td>0" . $row["telefon"] . "</td>";                else                  echo "<td></td>";    echo "<td>" . ($row["kategori"]) . "</td>";                echo "<td>" . ($row["datum"]->format('Y-m-d')) . "</td></tr>";                $i++;                }                                }              $double = false;                }                                          } else {              echo "Inga resultat";              }                                          } else {              echo ( print_r("Kritiskt databasfel"));              die( print_r( sqlsrv_errors(), true));              }                                   echo "</table>";              ?>	   </body></html><?php   	  sqlsrv_close;?> 