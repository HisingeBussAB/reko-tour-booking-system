<?phpinclude ("config-connect.php");?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head>	<title>Påstigningslista</title>	<meta charset="utf-8"> 	<style> @media print {    .page-break	{ display: block; page-break-before: always; }        .no-print, .no-print *    {        display: none !important;    }    .noborder	{ border-color:transparent; }  }  @page {    size:8.27in 11.69in;     margin:20mm;     mso-header-margin:0mm;      mso-footer-margin:0mm;     mso-paper-source:1;  }  </style>	</head><body style="padding:7px;"><form action="pastigningslista.php?resaid=<?php echo $_GET["resaid"] ?>&excel=true" method="post"><div class="no-print" align="center"><input class="no-print" type="submit" value="Excelformat">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input class="no-print" type="button" value="Skriv ut" onclick="window.print()"></div><table><?php	         $sql = "SELECT resa FROM Resor WHERE resaid=" . $_GET["resaid"];             if ($result = sqlsrv_query($conn, $sql, array(), array( "Scrollable" => SQLSRV_CURSOR_KEYSET ))) {        if (sqlsrv_num_rows($result) > 0) {        $row = sqlsrv_fetch_array($result, SQLSRV_FETCH_ASSOC );        $resanamn = $row["resa"];        }      echo "<tr><td colspan='4'><big><b>Påstigningslista " . $resanamn . "</b></big></td></tr>";     }          if ($_GET["excel"]=="true") {        $onskemalarr=$_POST["onskemal"];             }                       // $sql = "SELECT bokningid, fornamn, efternamn, telefon, adress, onskemal, avresa, avresatid, namn2, namn3, namn4, namn5, namn6 FROM Bokningar WHERE resaid=" . $_GET["resaid"] . " AND makulerad='false' AND sekondar='false' ORDER BY avresatid, bokningid";                   $avresaarr = array();      $iavresaarr = 0;      $flagavresatid = -1;      $avresatidarr = array();            $ionskemal=0;      $printedrows=0;      $printedrows2=0;                  $sql = "SELECT avresa, avresatid FROM Resenarer INNER JOIN Bokningar ON Bokningar.bokningid = Resenarer.bokningid WHERE Bokningar.resaid=" . $_GET["resaid"] . " AND makulerad='false' ORDER BY avresatid, Resenarer.bokningid, bekraftelse";             if ($result = sqlsrv_query($conn, $sql, array(), array( "Scrollable" => SQLSRV_CURSOR_KEYSET ))) {          if (sqlsrv_num_rows($result) > 0) {            while ($row = sqlsrv_fetch_array($result, SQLSRV_FETCH_ASSOC )) {                            if ($flagavresatid != $row["avresatid"]->format('H:i')) {                $avresaarr[$iavresaarr] = "<tr><td colspan='3'><b><big>" . $row["avresa"] . " kl " . $row["avresatid"]->format('H:i') . "</big></b></td></tr>";                $avresatidarr[$iavresaarr] = $row["avresatid"]->format('H:i');                $iavresaarr++;                $flagavresatid = $row["avresatid"]->format('H:i');              }                            }              } else {              echo "Inga resultat";              }              } else {              echo ( print_r("Kritiskt databasfel"));              die( print_r( sqlsrv_errors(), true));              }                                          $i=0;                            foreach($avresaarr as $value) {                                    $flag=1;                  $antal=0;                                    $sql = "SELECT *,REPLACE(onskemal, CHAR(13) + CHAR(10), ', ') AS onskemal FROM Resenarer INNER JOIN Bokningar ON Bokningar.bokningid = Resenarer.bokningid WHERE Bokningar.resaid=" . $_GET["resaid"] . " AND makulerad='false' AND avresatid='" . $avresatidarr[$i] . "' ORDER BY Resenarer.bokningid";                             if ($result = sqlsrv_query($conn, $sql, array(), array( "Scrollable" => SQLSRV_CURSOR_KEYSET ))) {                          if (sqlsrv_num_rows($result) > 0) {                            while ($row = sqlsrv_fetch_array($result, SQLSRV_FETCH_ASSOC )) {                                                            if ($flag==1) {                                                              if (($printedrows2 > 26)) {                                  $printedrows2 = 0;                                  echo "</table><table class='page-break'>";                                  }                                echo $value;                                $printedrows2++;                                $printedrows++;                                $flag=0;                              }                                                            $telefon = "-";                                                            if ($row["telefon"]==0) {                                  $sql2 = "SELECT telefon FROM Bokningar WHERE resaid=" . $_GET["resaid"] . " AND sekondar='true' AND huvudbokning=" . $row["bokningid"];                                             if ($result2 = sqlsrv_query($conn, $sql2, array(), array( "Scrollable" => SQLSRV_CURSOR_KEYSET ))) {                                          if (sqlsrv_num_rows($result2) > 0) {                                          $row2 = sqlsrv_fetch_array($result2, SQLSRV_FETCH_ASSOC );                                          $telefon = "0" . $row2["telefon"];                                          $telefon = strrev(chunk_split (strrev($telefon), 2,' '));                                          $telefon = preg_replace('/\s+/', '', $telefon, 2);                                    }}                              }                                              if ($row["telefon"]!=0) {                                $telefon = "0" . $row["telefon"];                                $telefon = strrev(chunk_split (strrev($telefon), 2,' '));                                $telefon = preg_replace('/\s+/', '', $telefon, 2);                              }                                               $onskemal = "<input type='text' class='noborder' name='onskemal[]' value='" . $row["onskemal"] . "' size=40>";                                if ($_GET["excel"]=="true") {                                  $onskemal = $onskemalarr[$ionskemal];                                  $ionskemal++;                                }                                           echo "<tr><td nowrap style='padding-right: 10px;'>" . $row["fornamn"] . " " . $row["efternamn"] . "</td><td nowrap style='padding-right: 10px;'>" . $telefon . "</td><td>" . $onskemal . "</td></tr>";                          $printedrows++;                          $printedrows2++;                          $antal++;                                                    //PRINT EXTRA NAMES                          if ($row["namn2"]!="" AND $row["separat2"]!=1 AND $row["sekondar"]!=1) {                              echo "<tr><td nowrap style='padding-right: 10px;'>" . $row["namn2"] . "</td><td  style='padding-right: 10px;'>&quot;</td><td>&quot;</td></tr>";                              $printedrows++;                              $printedrows2++;                              $antal++;                              }                                                        if ($row["namn3"]!="" AND $row["separat3"]!=1 AND $row["sekondar"]!=1) {                              echo "<tr><td nowrap style='padding-right: 10px;'>" . $row["namn3"] . "</td><td  style='padding-right: 10px;'>&quot;</td><td>&quot;</td></tr>";                                  $printedrows++;                              $printedrows2++;                              $antal++;                              }                                                        if ($row["namn4"]!="" AND $row["separat4"]!=1 AND $row["sekondar"]!=1) {                              echo "<tr><td nowrap style='padding-right: 10px;'>" . $row["namn4"] . "</td><td  style='padding-right: 10px;'>&quot;</td><td>&quot;</td></tr>";                              $printedrows++;                              $printedrows2++;                              $antal++;                              }                                                        if ($row["namn5"]!="" AND $row["separat5"]!=1 AND $row["sekondar"]!=1) {                              echo "<tr><td nowrap style='padding-right: 10px;'>" . $row["namn5"] . "</td><td  style='padding-right: 10px;'>&quot;</td><td>&quot;</td></tr>";                              $printedrows++;                              $printedrows2++;                              $antal++;                              }                                                        if ($row["namn6"]!="" AND $row["separat6"]!=1 AND $row["sekondar"]!=1) {                              echo "<tr><td  style='padding-right: 10px;'>" . $row["namn6"] . "</td><td  style='padding-right: 10px;'>&quot;</td><td>&quot;</td></tr>";                              $printedrows++;                              $printedrows2++;                              $antal++;                              }                                      }}}                                $i++;                            echo "<tr><td colspan='3'><b>Totalt " . ($antal) . " personer.</b></td></tr>";              echo "<tr><td colspan='3'>&nbsp;</td></tr>";              $printedrows++;              $printedrows2++;              $printedrows2++;               $printedrows++;                }                 /*             if ($result = sqlsrv_query($conn, $sql, array(), array( "Scrollable" => SQLSRV_CURSOR_KEYSET ))) {          if (sqlsrv_num_rows($result) > 0) {          while ($row = sqlsrv_fetch_array($result, SQLSRV_FETCH_ASSOC )) {                      $telefon = "";                                if ($row["telefon"]!=0) {                  $telefon = "0" . $row["telefon"];                  $telefon = strrev(chunk_split (strrev($telefon), 2,' '));                  $telefon = preg_replace('/\s+/', '', $telefon, 2);                 }                                  $onskemal = $row["onskemal"];                 if ($_GET["excel"]=="true") {                    $onskemal = $onskemalarr[$ionskemal];                    $ionskemal++;                }                           $pastigningstring = $pastigningstring . "<tr><td  style='padding-right: 10px;'>" . $row["fornamn"] . " " . $row["efternamn"] . "</td><td  style='padding-right: 10px;'>" . $telefon . "</td><td><input type='text' class='noborder' name='onskemal[]' value='" . $row["onskemal"] . "' size=30></td></tr>";                                                              if ($avresa!=$row["avresa"]) {                                                          echo "<tr><td colspan='3'><b><big>" . $row["avresa"] . " kl " . $row["avresatid"]->format('H:i') . "</big></b></td></tr>";              echo "<tr><td  style='padding-right: 10px;'>" . $row["fornamn"] . " " . $row["efternamn"] . "</td><td  style='padding-right: 10px;'>" . $telefon . "</td><td><input type='text' class='noborder' name='onskemal[]' value='" . $row["onskemal"] . "' size=30></td></tr>";              echo "<tr><td colspan='3'><b>Totalt " . ($antal) . " personer från " . $avresa . "</b></td></tr>";              echo "<tr><td colspan='3'>&nbsp;</td></tr>";              */                    ?>	   </table></form></body></html><?php   	  sqlsrv_close;?> 